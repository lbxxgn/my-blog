{% extends "base.html" %}

{% block title %}
{% if category %}{{ category.name }} - {% endif %}é¦–é¡µ - æˆ‘çš„åšå®¢
{% endblock %}

{% block content %}
<div class="container main-layout">
    <div class="content-wrapper">
        <div class="main-content">
            {% if categories %}
            <div class="category-filter">
                <a href="{{ url_for('index') }}" class="category-link {% if not category %}active{% endif %}">å…¨éƒ¨</a>
                {% for cat in categories %}
                    <a href="{{ url_for('view_category', category_id=cat.id) }}"
                       class="category-link {% if category and category.id == cat.id %}active{% endif %}">
                        {{ cat.name }}
                    </a>
                {% endfor %}
            </div>
            {% endif %}

            {% if posts %}
                <div id="posts-container" class="posts-list">
                    {% for post in posts %}
                        <a href="{{ url_for('view_post', post_id=post.id) }}" class="post-card-link">
                            <article class="post-card">
                                <h2>{{ post.title }}</h2>
                                <div class="post-meta">
                                    {% if post.category_name %}
                                    <span class="post-category">{{ post.category_name }}</span>
                                    <span>Â·</span>
                                    {% endif %}
                                    {% if post.author_display_name or post.author_username %}
                                    <span class="post-author">
                                        <a href="{{ url_for('view_author', author_id=post.author_id) }}" style="color: inherit; text-decoration: none;">
                                            ğŸ‘¤ {{ post.author_display_name or post.author_username }}
                                        </a>
                                    </span>
                                    <span>Â·</span>
                                    {% endif %}
                                    <time datetime="{{ post.created_at }}">{{ (post.created_at|localtime)[:10] }}</time>
                                </div>
                                <div class="post-excerpt">
                                    {{ post.content|excerpt }}
                                </div>
                            </article>
                        </a>
                    {% endfor %}
                </div>

                {% if pagination.page < pagination.total_pages %}
                <div class="load-more-container">
                    <button id="load-more" class="btn btn-primary" data-page="{{ pagination.page + 1 }}" data-category="{{ category.id if category else '' }}">
                        åŠ è½½æ›´å¤š
                    </button>
                </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <p>è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•æ–‡ç« ã€‚</p>
                </div>
            {% endif %}
        </div>

        <aside class="sidebar">
            {% if popular_tags %}
            <div class="sidebar-widget">
                <h3 class="widget-title">ğŸ”¥ çƒ­é—¨æ ‡ç­¾</h3>
                <div class="popular-tags">
                    {% for tag in popular_tags %}
                    <a href="{{ url_for('view_tag', tag_id=tag.id) }}" class="popular-tag">
                        #{{ tag.name }}
                        <span class="tag-count">{{ tag.post_count }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </aside>
    </div>
</div>

<!-- å¿«é€Ÿè®°äº‹æµ®åŠ¨æŒ‰é’®ï¼ˆä»…ç™»å½•ç”¨æˆ·å¯è§ï¼‰ -->
{% if session.get('user_id') %}
<button id="quickNoteFab" class="quick-note-fab" title="å¿«é€Ÿè®°äº‹">
    <span class="fab-icon">âœï¸</span>
    <span class="fab-text">å¿«é€Ÿè®°äº‹</span>
</button>

<!-- å¿«é€Ÿè®°äº‹æ¨¡æ€æ¡† -->
<div id="quickNoteModal" class="quick-note-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>âœï¸ å¿«é€Ÿè®°äº‹</h2>
            <button class="close-btn" id="closeModal">&times;</button>
        </div>
        <form id="quickNoteForm">
            <div class="form-group">
                <label for="noteTitle">æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="noteTitle" name="title" placeholder="ç»™è¿™ä¸ªæƒ³æ³•èµ·ä¸ªæ ‡é¢˜...">
            </div>
            <div class="form-group">
                <label for="noteContent">å†…å®¹ *</label>
                <textarea id="noteContent" name="content" rows="8" placeholder="è®°å½•ä½ çš„æƒ³æ³•..." required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<style>
/* å¿«é€Ÿè®°äº‹æµ®åŠ¨æŒ‰é’® */
.quick-note-fab {
    position: fixed;
    bottom: 30px;
    right: 30px;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.quick-note-fab:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 6px 30px rgba(102, 126, 234, 0.5);
}

.quick-note-fab:active {
    transform: translateY(0) scale(0.98);
}

.fab-icon {
    font-size: 22px;
    line-height: 1;
}

.fab-text {
    font-size: 15px;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.quick-note-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.quick-note-modal .modal-content {
    background: white;
    border-radius: 16px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 28px;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h2 {
    margin: 0;
    font-size: 22px;
    color: #1f2937;
}

.close-btn {
    background: none;
    border: none;
    font-size: 32px;
    color: #9ca3af;
    cursor: pointer;
    padding: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
}

.close-btn:hover {
    background: #f3f4f6;
    color: #374151;
}

.form-group {
    padding: 20px 28px;
}

.form-group:first-of-type {
    padding-top: 28px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
    font-size: 14px;
}

.form-group input[type="text"],
.form-group textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
    box-sizing: border-box;
}

.form-group input[type="text"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 120px;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 28px;
    border-top: 1px solid #e5e7eb;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
}

.btn-secondary:hover {
    background: #e5e7eb;
}

/* æš—è‰²ä¸»é¢˜é€‚é… */
.dark-theme .quick-note-modal .modal-content {
    background: #1f2937;
}

.dark-theme .modal-header {
    border-bottom-color: #374151;
}

.dark-theme .modal-header h2 {
    color: #f9fafb;
}

.dark-theme .form-group label {
    color: #e5e7eb;
}

.dark-theme .form-group input[type="text"],
.dark-theme .form-group textarea {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

.dark-theme .form-group input[type="text"]:focus,
.dark-theme .form-group textarea:focus {
    border-color: #818cf8;
    box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.1);
}

.dark-theme .form-actions {
    border-top-color: #374151;
}

.dark-theme .close-btn {
    color: #6b7280;
}

.dark-theme .close-btn:hover {
    background: #374151;
    color: #e5e7eb;
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
    .quick-note-fab {
        bottom: 20px;
        right: 20px;
        padding: 12px 18px;
    }

    .fab-text {
        display: none;
    }

    .quick-note-modal .modal-content {
        width: 95%;
        margin: 10px;
    }

    .modal-header {
        padding: 20px;
    }

    .modal-header h2 {
        font-size: 20px;
    }

    .form-group {
        padding: 16px 20px;
    }

    .form-actions {
        padding: 16px 20px;
    }
}
</style>

<script>
// å¿«é€Ÿè®°äº‹åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const fab = document.getElementById('quickNoteFab');
    const modal = document.getElementById('quickNoteModal');
    const closeBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const form = document.getElementById('quickNoteForm');

    // æ‰“å¼€æ¨¡æ€æ¡†
    fab.addEventListener('click', function() {
        modal.style.display = 'flex';
        document.getElementById('noteTitle').focus();
    });

    // å…³é—­æ¨¡æ€æ¡†å‡½æ•°
    function closeModal() {
        modal.style.display = 'none';
        form.reset();
    }

    // å…³é—­æŒ‰é’®
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // ESCé”®å…³é—­
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
        }
    });

    // è¡¨å•æäº¤
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const title = document.getElementById('noteTitle').value.trim();
        const content = document.getElementById('noteContent').value.trim();

        if (!content) {
            alert('è¯·è¾“å…¥å†…å®¹');
            return;
        }

        // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'ä¿å­˜ä¸­...';

        try {
            const response = await fetch('/knowledge_base/quick-note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    content: content
                })
            });

            const data = await response.json();

            if (data.success) {
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                closeModal();
                alert('âœ… è®°äº‹ä¿å­˜æˆåŠŸï¼');

                // å¯é€‰ï¼šè·³è½¬åˆ°æ—¶é—´çº¿æŸ¥çœ‹
                // window.location.href = '/knowledge_base/timeline';
            } else {
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                submitBtn.disabled = false;
                submitBtn.textContent = 'ä¿å­˜';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            submitBtn.disabled = false;
            submitBtn.textContent = 'ä¿å­˜';
        }
    });
});
</script>
{% endif %}
{% endblock %}
