{% extends "base.html" %}

{% block title %}
{% if post %}ç¼–è¾‘æ–‡ç«  - {{ post.title }}{% else %}æ–°å»ºæ–‡ç« {% endif %} - æˆ‘çš„åšå®¢
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/quill.css') }}">
{% endblock %}

{% block page_type %}editor{% endblock %}

{% block content %}
<div class="container admin-editor">
    <h2>{% if post %}ç¼–è¾‘æ–‡ç« {% else %}æ–°å»ºæ–‡ç« {% endif %}</h2>

    <!-- è‰ç¨¿æ¢å¤æç¤º -->
    <div id="draftRecovery" class="draft-recovery" style="display: none;">
        <div class="draft-recovery-content">
            <span class="recovery-icon">ğŸ’¾</span>
            <span class="recovery-text">æ£€æµ‹åˆ°æœªä¿å­˜çš„è‰ç¨¿ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ</span>
            <div class="recovery-actions">
                <button type="button" class="btn btn-sm btn-primary" onclick="recoverDraft()">æ¢å¤</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="discardDraft()">ä¸¢å¼ƒ</button>
            </div>
        </div>
    </div>

    <!-- è‡ªåŠ¨ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="autosave-indicator" id="autosaveIndicator">
        <span class="indicator-dot"></span>
        <span class="indicator-text">å·²ä¿å­˜</span>
    </div>

    <form method="POST" class="editor-form" id="editorForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="form-group">
            <label for="title">æ ‡é¢˜</label>
            <input type="text" id="title" name="title" value="{% if post %}{{ post.title }}{% endif %}" required>
        </div>

        <div class="form-group">
            <label for="content">å†…å®¹</label>
            <textarea id="content" name="content" rows="20" required>{% if post %}{{ post.content }}{% endif %}</textarea>
            <!-- Hidden file input for image upload -->
            <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
            <div id="saveStatus" class="save-status"></div>
        </div>

        <!-- åˆ†ç±»å’Œæ ‡ç­¾åˆå¹¶ä¸ºä¸€è¡Œ -->
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label for="category_id">åˆ†ç±»</label>
                <select id="category_id" name="category_id" style="width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--border-color, #d1d5db); border-radius: 6px; font-size: 0.95rem; background: var(--card-bg, #fff); color: var(--text-color, #1f2937); cursor: pointer; transition: all 0.2s;">
                    <option value="">æ— åˆ†ç±»</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}"
                        {% if post and post.category_id == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" style="flex: 2;">
                <label for="tags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                    <input type="text" name="tags" id="tags" value="{% if post and post.tags %}{{ post.tags|map(attribute='name')|join(', ') }}{% endif %}" placeholder="ä¾‹å¦‚: Python, Flask, Web" style="flex: 1; padding: 0.625rem 0.875rem; border: 1px solid var(--border-color, #d1d5db); border-radius: 6px; font-size: 0.95rem; transition: all 0.2s;">
                    <button type="button" id="aiGenerateBtn" class="btn btn-secondary ai-feature" onclick="generateAITags()" title="ä½¿ç”¨AIç”Ÿæˆæ ‡ç­¾" style="flex-shrink: 0;">
                        <span style="display: flex; align-items: center; gap: 0.25rem;">
                            <span class="ai-icon">ğŸ¤–</span>
                            <span>AIç”Ÿæˆ</span>
                        </span>
                    </button>
                </div>
                <small style="color: #666;">å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”</small>
                <div id="aiStatus" class="ai-status" style="display: none;"></div>
            </div>
        </div>

        <!-- AIå·¥å…·æ  -->
        <div id="aiToolsSection" class="ai-tools-section ai-feature" style="margin-top: 1.5rem; padding: 1.25rem; border: 1px solid var(--border-color, #e5e7eb); border-radius: 8px; background: var(--code-bg, #f9fafb);">
            <h3 style="font-size: 1rem; margin: 0 0 1rem 0; color: var(--text-color, #1f2937); display: flex; align-items: center; gap: 0.5rem;">
                <span>ğŸ¤–</span>
                <span>AIåŠ©æ‰‹å·¥å…·</span>
            </h3>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-secondary" onclick="generateAISummary()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    <span style="display: flex; align-items: center; gap: 0.375rem;">
                        <span>ğŸ“</span>
                        <span>ç”Ÿæˆæ‘˜è¦</span>
                    </span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="generateAIRecommendations()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    <span style="display: flex; align-items: center; gap: 0.375rem;">
                        <span>ğŸ”—</span>
                        <span>æ¨èç›¸å…³æ–‡ç« </span>
                    </span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="continueAIWriting()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    <span style="display: flex; align-items: center; gap: 0.375rem;">
                        <span>âœï¸</span>
                        <span>AIç»­å†™</span>
                    </span>
                </button>
            </div>
            <div id="aiToolsStatus" class="ai-status" style="display: none; margin-top: 1rem;"></div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="editor-footer">
            <input type="checkbox" name="is_published" id="is_published" {% if post and post.is_published %}checked{% endif %} style="display: none;">

            <!-- å·¦ä¾§ï¼šæƒé™è®¾ç½® -->
            <div class="footer-left">
                <div class="access-setting">
                    <label for="access_level" style="font-size: 0.875rem; color: var(--text-secondary, #666); margin-bottom: 0.25rem;">è®¿é—®æƒé™</label>
                    <select id="access_level" name="access_level" onchange="togglePasswordField()" style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color, #d1d5db); border-radius: 6px; font-size: 0.9rem; background: var(--card-bg, #fff); color: var(--text-color, #1f2937);">
                        <option value="public" {% if not post or post.get('access_level') == 'public' or post.get('access_level') is none %}selected{% endif %}>ğŸŒ å…¬å¼€</option>
                        <option value="login" {% if post and post.get('access_level') == 'login' %}selected{% endif %}>ğŸ”’ ç™»å½•ç”¨æˆ·</option>
                        <option value="password" {% if post and post.get('access_level') == 'password' %}selected{% endif %}>ğŸ”‘ å¯†ç ä¿æŠ¤</option>
                        <option value="private" {% if post and post.get('access_level') == 'private' %}selected{% endif %}>ğŸ‘ï¸ ç§å¯†</option>
                    </select>
                    <input type="text" id="access_password" name="access_password" value="{% if post and post.get('access_password') %}{{ post.access_password }}{% endif %}" placeholder="è®¾ç½®å¯†ç " style="display: none; margin-left: 0.5rem; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color, #d1d5db); border-radius: 6px; font-size: 0.9rem; width: 150px;">
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’® -->
            <div class="footer-right">
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">å–æ¶ˆ</a>
                {% if not post or not post.is_published %}
                <button type="button" id="publishToggle" class="btn btn-primary" onclick="togglePublish()">ç«‹å³å‘å¸ƒ</button>
                {% endif %}
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </form>
</div>

<!-- Link Quill CSS from CDN -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
/* Form Row Layout */
.form-row {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.form-row .form-group {
    margin-bottom: 0;
}

/* Form input and select styles */
.form-row input[type="text"],
.form-row select {
    width: 100%;
}

.form-row input[type="text"]:focus,
.form-row select:focus {
    outline: none;
    border-color: var(--primary-color, #10b981);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.form-row select:hover {
    border-color: #9ca3af;
}

/* Dark theme fixes */
.dark-theme .form-row input[type="text"],
.dark-theme .form-row select {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

.dark-theme .form-row input[type="text"]:focus,
.dark-theme .form-row select:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
}

.dark-theme .form-row select:hover {
    border-color: #6b7280;
}

/* Responsive for form row */
@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
        gap: 1rem;
    }
}

/* Editor Footer Layout */
.editor-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    margin-top: 2rem;
    border-top: 1px solid var(--border-color, #e5e7eb);
}

.footer-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.access-setting {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.access-setting label {
    white-space: nowrap;
}

.footer-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* Button Styles */
.btn-primary {
    background: var(--primary-color, #10b981);
    color: white;
    border: 1px solid var(--primary-color, #10b981);
}

.btn-primary:hover {
    background: #059669;
    border-color: #059669;
}

.btn-secondary {
    background: white;
    color: var(--text-color, #1f2937);
    border: 1px solid var(--border-color, #d1d5db);
}

.btn-secondary:hover {
    background: var(--code-bg, #f9fafb);
    border-color: var(--border-color, #d1d5db);
}

.dark-theme .btn-secondary {
    background: #374151;
    color: #f9fafb;
    border-color: #4b5563;
}

.dark-theme .btn-secondary:hover {
    background: #4b5563;
}

/* Responsive */
@media (max-width: 768px) {
    .editor-footer {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }

    .footer-left,
    .footer-right {
        width: 100%;
        justify-content: center;
    }

    .access-setting {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .footer-right {
        flex-wrap: wrap;
    }
}

/* AI Button Styles */
.ai-generate-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
}

.ai-icon {
    font-size: 1rem;
}

.ai-status {
    margin-top: 0.5rem;
    padding: 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ai-status.loading {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #3b82f6;
}

.ai-status.success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #10b981;
}

.ai-status.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #ef4444;
}

.ai-spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.dark-theme .ai-status.loading {
    background: #1e3a8a;
    color: #bfdbfe;
}

.dark-theme .ai-status.success {
    background: #064e3b;
    color: #d1fae5;
}

.dark-theme .ai-status.error {
    background: #7f1d1d;
    color: #fecaca;
}

/* ==================== è‡ªåŠ¨ä¿å­˜æ ·å¼ ==================== */

/* è‡ªåŠ¨ä¿å­˜æŒ‡ç¤ºå™¨ */
.autosave-indicator {
    position: fixed;
    top: 80px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--card-bg, #fff);
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 20px;
    font-size: 0.875rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 1000;
    transition: all 0.3s ease;
}

.indicator-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.indicator-dot.dot-saving {
    background: #fbbf24;
    animation: pulse 1s infinite;
}

.indicator-dot.dot-saved {
    background: #10b981;
    animation: none;
}

.indicator-dot.dot-error {
    background: #ef4444;
    animation: none;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

/* è‰ç¨¿æ¢å¤æç¤º */
.draft-recovery {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    z-index: 2000;
    padding: 20px;
    display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.draft-recovery-content {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 15px;
}

.recovery-icon {
    font-size: 2rem;
}

.recovery-text {
    flex: 1;
    font-size: 1rem;
}

.recovery-actions {
    display: flex;
    gap: 10px;
}

.recovery-actions .btn {
    padding: 8px 20px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.recovery-actions .btn-primary {
    background: white;
    color: #667eea;
}

.recovery-actions .btn-primary:hover {
    background: #f0f0f0;
}

.recovery-actions .btn-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.recovery-actions .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .autosave-indicator {
        top: auto;
        bottom: 20px;
        right: 20px;
    }

    .draft-recovery-content {
        flex-direction: column;
        text-align: center;
    }

    .recovery-actions {
        width: 100%;
        justify-content: center;
    }
}

</style>
{% endblock %}

{% block scripts %}
<!-- Load Quill from CDN -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="{{ url_for('static', filename='js/editor.js') }}?v=1.1"></script>

<script>
// ==================== è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ ====================

const AUTOSAVE_KEY = 'blog_draft_autosave';
const AUTOSAVE_DELAY = 3000; // 3ç§’åè‡ªåŠ¨ä¿å­˜
let autosaveTimer = null;
let lastSavedContent = '';

// åˆå§‹åŒ–è‡ªåŠ¨ä¿å­˜
function initAutosave() {
    const form = document.getElementById('editorForm');
    if (!form) return;

    const titleInput = document.getElementById('title');
    const contentTextarea = document.getElementById('content');

    // ç›‘å¬å†…å®¹å˜åŒ–
    if (titleInput) {
        titleInput.addEventListener('input', () => {
            scheduleAutosave();
        });
    }

    if (contentTextarea) {
        contentTextarea.addEventListener('input', () => {
            scheduleAutosave();
        });
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è‰ç¨¿
    checkForDraft();

    // é¡µé¢å¸è½½å‰ä¿å­˜è‰ç¨¿
    window.addEventListener('beforeunload', () => {
        if (hasUnsavedChanges()) {
            saveDraftToStorage();
        }
    });
}

// å®‰æ’è‡ªåŠ¨ä¿å­˜
function scheduleAutosave() {
    if (autosaveTimer) {
        clearTimeout(autosaveTimer);
    }

    updateAutosaveStatus('saving');

    autosaveTimer = setTimeout(() => {
        saveDraftToStorage();
    }, AUTOSAVE_DELAY);
}

// ä¿å­˜è‰ç¨¿åˆ° LocalStorage
function saveDraftToStorage() {
    const form = document.getElementById('editorForm');
    if (!form) return;

    const formData = new FormData(form);
    const draft = {
        title: formData.get('title') || '',
        content: formData.get('content') || '',
        category_id: formData.get('category_id') || '',
        tags: formData.get('tags') || '',
        access_level: formData.get('access_level') || 'public',
        access_password: formData.get('access_password') || '',
        saved_at: new Date().toISOString()
    };

    try {
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(draft));
        lastSavedContent = JSON.stringify(draft);
        updateAutosaveStatus('saved');
        console.log('[Autosave] Draft saved');
    } catch (e) {
        console.error('[Autosave] Failed to save draft:', e);
        updateAutosaveStatus('error');
    }
}

// æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„è‰ç¨¿
function checkForDraft() {
    try {
        const draftJson = localStorage.getItem(AUTOSAVE_KEY);
        if (!draftJson) return;

        const draft = JSON.parse(draftJson);

        // æ£€æŸ¥è‰ç¨¿æ˜¯å¦ä¸å½“å‰å†…å®¹ä¸åŒ
        const currentTitle = document.getElementById('title').value;
        const currentContent = document.getElementById('content').value;

        if (draft.title === currentTitle && draft.content === currentContent) {
            // å†…å®¹ç›¸åŒï¼Œç§»é™¤è‰ç¨¿
            localStorage.removeItem(AUTOSAVE_KEY);
            return;
        }

        // æ˜¾ç¤ºæ¢å¤æç¤º
        showDraftRecovery(draft);
    } catch (e) {
        console.error('[Autosave] Failed to check draft:', e);
    }
}

// æ˜¾ç¤ºè‰ç¨¿æ¢å¤æç¤º
function showDraftRecovery(draft) {
    const recoveryDiv = document.getElementById('draftRecovery');
    if (!recoveryDiv) return;

    const savedTime = new Date(draft.saved_at);
    const timeStr = formatTimeAgo(savedTime);

    recoveryDiv.querySelector('.recovery-text').textContent =
        `æ£€æµ‹åˆ° ${timeStr} çš„æœªä¿å­˜è‰ç¨¿ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ`;

    recoveryDiv.style.display = 'block';

    // ä¿å­˜è‰ç¨¿æ•°æ®åˆ°å…ƒç´ 
    recoveryDiv.dataset.draft = JSON.stringify(draft);
}

// æ¢å¤è‰ç¨¿
function recoverDraft() {
    const recoveryDiv = document.getElementById('draftRecovery');
    if (!recoveryDiv) return;

    try {
        const draft = JSON.parse(recoveryDiv.dataset.draft);

        // å¡«å……è¡¨å•
        document.getElementById('title').value = draft.title;
        document.getElementById('content').value = draft.content;

        if (draft.category_id) {
            document.getElementById('category_id').value = draft.category_id;
        }

        if (draft.tags) {
            document.getElementById('tags').value = draft.tags;
        }

        if (draft.access_level) {
            document.getElementById('access_level').value = draft.access_level;
        }

        // éšè—æ¢å¤æç¤º
        recoveryDiv.style.display = 'none';

        // è§¦å‘ Quill æ›´æ–°
        if (window.quill) {
            window.quill.root.innerHTML = draft.content;
        }

        updateAutosaveStatus('recovered');

        // 3ç§’åæ›´æ–°çŠ¶æ€ä¸ºå·²ä¿å­˜
        setTimeout(() => {
            updateAutosaveStatus('saved');
        }, 3000);

        console.log('[Autosave] Draft recovered');
    } catch (e) {
        console.error('[Autosave] Failed to recover draft:', e);
    }
}

// ä¸¢å¼ƒè‰ç¨¿
function discardDraft() {
    try {
        localStorage.removeItem(AUTOSAVE_KEY);

        const recoveryDiv = document.getElementById('draftRecovery');
        if (recoveryDiv) {
            recoveryDiv.style.display = 'none';
        }

        updateAutosaveStatus('saved');
        console.log('[Autosave] Draft discarded');
    } catch (e) {
        console.error('[Autosave] Failed to discard draft:', e);
    }
}

// æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
function hasUnsavedChanges() {
    const form = document.getElementById('editorForm');
    if (!form) return false;

    const formData = new FormData(form);
    const currentContent = {
        title: formData.get('title') || '',
        content: formData.get('content') || ''
    };

    return JSON.stringify(currentContent) !== lastSavedContent;
}

// æ›´æ–°è‡ªåŠ¨ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨
function updateAutosaveStatus(status) {
    const indicator = document.getElementById('autosaveIndicator');
    if (!indicator) return;

    const dot = indicator.querySelector('.indicator-dot');
    const text = indicator.querySelector('.indicator-text');

    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
    indicator.classList.remove('status-saving', 'status-saved', 'status-error');
    dot.classList.remove('dot-saving', 'dot-saved', 'dot-error');

    switch (status) {
        case 'saving':
            indicator.classList.add('status-saving');
            dot.classList.add('dot-saving');
            text.textContent = 'æ­£åœ¨ä¿å­˜...';
            break;
        case 'saved':
            indicator.classList.add('status-saved');
            dot.classList.add('dot-saved');
            text.textContent = 'å·²ä¿å­˜';
            break;
        case 'error':
            indicator.classList.add('status-error');
            dot.classList.add('dot-error');
            text.textContent = 'ä¿å­˜å¤±è´¥';
            break;
        case 'recovered':
            indicator.classList.add('status-saved');
            dot.classList.add('dot-saved');
            text.textContent = 'å·²æ¢å¤è‰ç¨¿';
            break;
    }
}

// æ ¼å¼åŒ–æ—¶é—´å·®
function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    if (seconds < 60) {
        return `${seconds}ç§’å‰`;
    }

    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) {
        return `${minutes}åˆ†é’Ÿå‰`;
    }

    const hours = Math.floor(minutes / 60);
    if (hours < 24) {
        return `${hours}å°æ—¶å‰`;
    }

    const days = Math.floor(hours / 24);
    return `${days}å¤©å‰`;
}

// æ–‡ç« å‘å¸ƒæˆåŠŸåæ¸…é™¤è‰ç¨¿
function clearDraftAfterPublish() {
    try {
        localStorage.removeItem(AUTOSAVE_KEY);
        console.log('[Autosave] Draft cleared after publish');
    } catch (e) {
        console.error('[Autosave] Failed to clear draft:', e);
    }
}

// Publish and save article
function togglePublish() {
    const checkbox = document.getElementById('is_published');
    const form = document.getElementById('editorForm');

    // Set publish status to true
    checkbox.checked = true;

    // Submit the form to save and publish
    form.submit();
}

// Toggle password field visibility
function togglePasswordField() {
    const accessLevel = document.getElementById('access_level').value;
    const passwordInput = document.getElementById('access_password');

    if (accessLevel === 'password') {
        passwordInput.style.display = 'inline-block';
    } else {
        passwordInput.style.display = 'none';
        passwordInput.value = '';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    togglePasswordField();

    // Check AI features status and show/hide accordingly
    checkAIFeaturesStatus();

    // Initialize autosave
    initAutosave();
});

// Check AI features status from server
async function checkAIFeaturesStatus() {
    try {
        const response = await fetch('/admin/ai/status');
        if (response.ok) {
            const data = await response.json();
            const aiEnabled = data.ai_enabled || false;

            console.log('[AI Features] Status:', aiEnabled ? 'enabled' : 'disabled');

            // Hide all AI features if disabled
            if (!aiEnabled) {
                const aiFeatures = document.querySelectorAll('.ai-feature');
                aiFeatures.forEach(element => {
                    element.style.display = 'none';
                });
                console.log('[AI Features] Hidden all AI features');
            }
        }
    } catch (error) {
        console.error('[AI Features] Failed to check status:', error);
        // On error, show features by default
    }
}

// Show AI tools status message
function showAiToolsStatus(type, message) {
    const statusDiv = document.getElementById('aiToolsStatus');
    statusDiv.className = 'ai-status ' + type;
    statusDiv.style.display = 'flex';
    statusDiv.innerHTML = message;

    // Auto hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
}

// Generate AI summary
async function generateAISummary() {
    const title = document.getElementById('title').value.trim();

    // Get content from Quill editor if available, otherwise from textarea
    let content;
    if (window.quill) {
        content = window.quill.getText().trim();
    } else {
        content = document.getElementById('content').value.trim();
    }

    if (!title) {
        showAiToolsStatus('error', 'âŒ è¯·å…ˆè¾“å…¥æ–‡ç« æ ‡é¢˜');
        return;
    }

    if (!content) {
        showAiToolsStatus('error', 'âŒ è¯·å…ˆè¾“å…¥æ–‡ç« å†…å®¹');
        return;
    }

    // Get post ID from URL if editing
    const pathParts = window.location.pathname.split('/');
    let postId = pathParts[pathParts.length - 1];
    // If postId is not a number, we're creating a new post
    if (isNaN(parseInt(postId))) {
        postId = null;
    }

    showAiToolsStatus('loading', 'ğŸ¤– AIæ­£åœ¨ç”Ÿæˆæ‘˜è¦...');

    const csrfToken = document.querySelector('meta[name="csrf_token"]').content;

    try {
        const response = await fetch('/admin/ai/generate-summary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                post_id: postId,
                title: title,
                content: content
            })
        });

        const data = await response.json();

        if (data.success) {
            // Display summary and offer to append to content
            const summary = data.summary;
            const shouldAppend = confirm(`AIç”Ÿæˆçš„æ‘˜è¦ï¼š\n\n${summary}\n\næ˜¯å¦å°†æ‘˜è¦æ·»åŠ åˆ°æ–‡ç« å¼€å¤´ï¼Ÿ`);

            if (shouldAppend) {
                if (window.quill) {
                    // Insert into Quill editor
                    const summaryHtml = `<p><strong>æ‘˜è¦ï¼š</strong>${summary}</p><p><br></p>`;
                    window.quill.clipboard.dangerouslyPasteHTML(0, summaryHtml);
                } else {
                    // Fallback to textarea
                    const contentTextarea = document.getElementById('content');
                    contentTextarea.value = `**æ‘˜è¦**ï¼š${summary}\n\n${contentTextarea.value}`;
                }
            }

            showAiToolsStatus('success', `âœ… æ‘˜è¦å·²ç”Ÿæˆ (${data.tokens_used} tokens, ${data.model})`);
        } else {
            showAiToolsStatus('error', `âŒ ${data.error || 'ç”Ÿæˆå¤±è´¥'}`);
        }
    } catch (error) {
        showAiToolsStatus('error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
    }
}

// Generate AI recommendations
async function generateAIRecommendations() {
    const title = document.getElementById('title').value.trim();

    // Get content from Quill editor if available, otherwise from textarea
    let content;
    if (window.quill) {
        content = window.quill.getText().trim();
    } else {
        content = document.getElementById('content').value.trim();
    }

    // Get post ID from URL if editing
    const pathParts = window.location.pathname.split('/');
    let postId = pathParts[pathParts.length - 1];
    if (isNaN(parseInt(postId))) {
        postId = null;
    }

    if (!postId) {
        showAiToolsStatus('error', 'âŒ è¯·å…ˆä¿å­˜æ–‡ç« ï¼Œç„¶åå†ç”Ÿæˆæ¨è');
        return;
    }

    if (!title || !content) {
        showAiToolsStatus('error', 'âŒ è¯·å…ˆè¾“å…¥æ–‡ç« æ ‡é¢˜å’Œå†…å®¹');
        return;
    }

    showAiToolsStatus('loading', 'ğŸ¤– AIæ­£åœ¨åˆ†æå¹¶æ¨èç›¸å…³æ–‡ç« ...');

    const csrfToken = document.querySelector('meta[name="csrf_token"]').content;

    try {
        const response = await fetch('/admin/ai/recommend-posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                post_id: postId,
                title: title,
                content: content
            })
        });

        const data = await response.json();

        if (data.success && data.recommendations.length > 0) {
            // æ£€æŸ¥è¿”å›æ ¼å¼ - å¦‚æœæ˜¯å¯¹è±¡æ•°ç»„åˆ™æ˜¾ç¤ºæ ‡é¢˜å’Œé“¾æ¥ï¼Œå¦‚æœæ˜¯IDæ•°ç»„åˆ™æ˜¾ç¤ºID
            console.log('=== æ¨èæ–‡ç« è°ƒè¯•ä¿¡æ¯ ===');
            console.log('å®Œæ•´æ•°æ®:', data.recommendations);
            console.log('æ•°æ®ç±»å‹:', typeof data.recommendations);
            console.log('ç¬¬ä¸€é¡¹:', data.recommendations[0]);
            console.log('ç¬¬ä¸€é¡¹ç±»å‹:', typeof data.recommendations[0]);
            console.log('æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(data.recommendations[0]));

            const recList = data.recommendations.map((rec, index) => {
                console.log(`å¤„ç†ç¬¬${index + 1}é¡¹:`, rec, 'ç±»å‹:', typeof rec, 'æ˜¯å¦æ•°ç»„:', Array.isArray(rec));

                // æƒ…å†µ1: æ–°æ ¼å¼ - åŒ…å«titleå’Œurlçš„å¯¹è±¡
                if (rec && typeof rec === 'object' && !Array.isArray(rec) && rec.title && rec.url) {
                    console.log('  -> ä½¿ç”¨æ–°æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰');
                    return `<a href="${rec.url}" target="_blank" class="recommendation-link">${rec.title}</a>`;
                }
                // æƒ…å†µ2: æ—§æ ¼å¼ - çº¯æ•°å­—ID
                else if (typeof rec === 'number') {
                    console.log('  -> ä½¿ç”¨æ—§æ ¼å¼ï¼ˆæ•°å­—ï¼‰');
                    return `æ–‡ç«  #${rec}`;
                }
                // æƒ…å†µ3: å¯èƒ½æ˜¯å­—ç¬¦ä¸²æ•°å­—
                else if (typeof rec === 'string' && !isNaN(parseInt(rec))) {
                    console.log('  -> ä½¿ç”¨æ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰');
                    return `æ–‡ç«  #${rec}`;
                }
                // æƒ…å†µ4: æœªçŸ¥æ ¼å¼
                else {
                    console.log('  -> æœªçŸ¥æ ¼å¼ï¼ŒJSONåºåˆ—åŒ–:', JSON.stringify(rec));
                    return `[${typeof rec}] ${JSON.stringify(rec)}`;
                }
            }).join(', ');

            console.log('æœ€ç»ˆç»“æœ:', recList);
            console.log('========================');

            showAiToolsStatus('success', `âœ… æ¨èæ–‡ç« ï¼š${recList} (${data.tokens_used} tokens)`);
        } else if (data.success && data.recommendations.length === 0) {
            showAiToolsStatus('success', 'âœ… æš‚æ— ç›¸å…³æ–‡ç« æ¨è');
        } else {
            showAiToolsStatus('error', `âŒ ${data.error || 'ç”Ÿæˆå¤±è´¥'}`);
        }
    } catch (error) {
        showAiToolsStatus('error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
    }
}

// Continue writing with AI
async function continueAIWriting() {
    const title = document.getElementById('title').value.trim();

    // Get content from Quill editor if available, otherwise from textarea
    let content;
    if (window.quill) {
        content = window.quill.getText().trim();
    } else {
        content = document.getElementById('content').value.trim();
    }

    if (!title) {
        showAiToolsStatus('error', 'âŒ è¯·å…ˆè¾“å…¥æ–‡ç« æ ‡é¢˜');
        return;
    }

    if (!content || content.length < 100) {
        showAiToolsStatus('error', 'âŒ æ–‡ç« å†…å®¹å¤ªçŸ­ï¼Œè¯·è‡³å°‘å†™100å­—åå†ä½¿ç”¨AIç»­å†™');
        return;
    }

    // Get post ID from URL if editing
    const pathParts = window.location.pathname.split('/');
    let postId = pathParts[pathParts.length - 1];
    // If postId is not a number, we're creating a new post
    if (isNaN(parseInt(postId))) {
        postId = null;
    }

    showAiToolsStatus('loading', 'ğŸ¤– AIæ­£åœ¨ç»­å†™å†…å®¹...');

    const csrfToken = document.querySelector('meta[name="csrf_token"]').content;

    try {
        const response = await fetch('/admin/ai/continue-writing', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                post_id: postId,
                title: title,
                content: content
            })
        });

        const data = await response.json();

        if (data.success) {
            const continuation = data.continuation;
            const shouldAppend = confirm(`AIç»­å†™å†…å®¹ï¼š\n\n${continuation.substring(0, 200)}...\n\næ˜¯å¦å°†æ­¤å†…å®¹æ·»åŠ åˆ°æ–‡ç« æœ«å°¾ï¼Ÿ`);

            if (shouldAppend) {
                if (window.quill) {
                    // Append to Quill editor
                    window.quill.clipboard.dangerouslyPasteHTML(window.quill.getLength(), `<p>${continuation}</p>`);
                } else {
                    // Fallback to textarea
                    const contentTextarea = document.getElementById('content');
                    contentTextarea.value = contentTextarea.value + '\n\n' + continuation;
                }
            }

            showAiToolsStatus('success', `âœ… ç»­å†™å®Œæˆ (${data.tokens_used} tokens, ${data.model})`);
        } else {
            showAiToolsStatus('error', `âŒ ${data.error || 'ç”Ÿæˆå¤±è´¥'}`);
        }
    } catch (error) {
        showAiToolsStatus('error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
    }
}

</script>
{% endblock %}
