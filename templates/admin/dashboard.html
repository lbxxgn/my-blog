{% extends "base.html" %}

{% block title %}管理后台 - 我的博客{% endblock %}

{% block content %}
<div class="container admin-dashboard">
    <div class="dashboard-header">
        <h2>文章管理</h2>
        <div class="header-actions">
            <a href="{{ url_for('category_list') }}" class="btn">分类管理</a>
            <a href="{{ url_for('tag_list') }}" class="btn">标签管理</a>
            <a href="{{ url_for('new_post') }}" class="btn btn-primary">新建文章</a>
        </div>
    </div>

    {% if posts %}
        <div class="filter-bar" style="margin-bottom: 1rem; padding: 1rem; background: var(--code-bg); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <label for="categoryFilter" style="font-weight: 500;">筛选分类：</label>
                <select id="categoryFilter" onchange="filterByCategory()" style="padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.95rem;">
                    <option value="" {% if not current_category_id %}selected{% endif %}>全部分类</option>
                    <option value="none" {% if current_category_id == 'none' %}selected{% endif %}>未分类</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if current_category_id == category.id|string %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <label for="perPageSelect" style="font-weight: 500; font-size: 0.9rem;">每页条数：</label>
                <select id="perPageSelect" onchange="changePerPage()" style="padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem;">
                    <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20</option>
                    <option value="40" {% if pagination.per_page == 40 %}selected{% endif %}>40</option>
                    <option value="80" {% if pagination.per_page == 80 %}selected{% endif %}>80</option>
                </select>
            </div>
        </div>

        <div id="batchActionsBar" class="batch-actions-bar" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #e0f2fe; border: 1px solid #0284c7; border-radius: 8px; align-items: center; gap: 1rem;">
            <span style="font-weight: 500;">已选择 <strong id="selectedCount">0</strong> 篇文章</span>
            <button type="button" class="btn btn-sm btn-primary" onclick="showBatchCategoryModal()">批量设置分类</button>
            <button type="button" class="btn btn-sm btn-danger" onclick="showBatchDeleteModal()">批量删除</button>
            <button type="button" class="btn btn-sm" onclick="clearSelection()">取消选择</button>
        </div>

        <table class="posts-table">
            <thead>
                <tr>
                    <th style="width: 50px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>标题</th>
                    <th>分类</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts %}
                    <tr data-post-id="{{ post.id }}">
                        <td><input type="checkbox" class="post-checkbox" value="{{ post.id }}" onchange="updateBatchActions()"></td>
                        <td><a href="{{ url_for('view_post', post_id=post.id) }}">{{ post.title }}</a></td>
                        <td>
                            {% if post.category_name %}
                                <span class="post-category">{{ post.category_name }}</span>
                            {% else %}
                                <span style="color: #999;">未分类</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if post.is_published %}
                                <span class="status published">已发布</span>
                            {% else %}
                                <span class="status draft">草稿</span>
                            {% endif %}
                        </td>
                        <td>{{ post.created_at }}</td>
                        <td class="actions">
                            <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-sm">编辑</a>
                            <form method="POST" action="{{ url_for('delete_post_route', post_id=post.id) }}" class="delete-form" onsubmit="return confirm('确定删除这篇文章？');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-sm btn-danger">删除</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if pagination.total_pages > 1 %}
        <div class="pagination-bar" style="margin-top: 1.5rem; padding: 1rem; background: var(--code-bg); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div style="color: #666; font-size: 0.9rem;">
                显示第 <strong>{{ start_item }}</strong> 到
                <strong>{{ end_item }}</strong> 条，
                共 <strong>{{ pagination.total }}</strong> 条
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                {% if pagination.page > 1 %}
                <a href="{{ url_for('admin_dashboard', page=1, per_page=pagination.per_page, category_id=current_category_id) }}" class="btn btn-sm">首页</a>
                <a href="{{ url_for('admin_dashboard', page=pagination.page-1, per_page=pagination.per_page, category_id=current_category_id) }}" class="btn btn-sm">上一页</a>
                {% endif %}

                <span style="display: flex; gap: 0.25rem; align-items: center;">
                    {% for p in page_range %}
                        {% if p == pagination.page %}
                        <span style="padding: 0.5rem 0.75rem; background: var(--primary-color); color: white; border-radius: 4px; font-weight: 500;">{{ p }}</span>
                        {% else %}
                        <a href="{{ url_for('admin_dashboard', page=p, per_page=pagination.per_page, category_id=current_category_id) }}" style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; text-decoration: none; color: var(--text-color);">{{ p }}</a>
                        {% endif %}
                    {% endfor %}

                    {% if show_ellipsis %}
                    <span style="color: #999;">...</span>
                    <a href="{{ url_for('admin_dashboard', page=pagination.total_pages, per_page=pagination.per_page, category_id=current_category_id) }}" style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; text-decoration: none; color: var(--text-color);">{{ pagination.total_pages }}</a>
                    {% endif %}
                </span>

                {% if pagination.page < pagination.total_pages %}
                <a href="{{ url_for('admin_dashboard', page=pagination.page+1, per_page=pagination.per_page, category_id=current_category_id) }}" class="btn btn-sm">下一页</a>
                <a href="{{ url_for('admin_dashboard', page=pagination.total_pages, per_page=pagination.per_page, category_id=current_category_id) }}" class="btn btn-sm">末页</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <p>还没有任何文章。<a href="{{ url_for('new_post') }}">创建第一篇</a></p>
        </div>
    {% endif %}
</div>

<!-- Batch Category Modal -->
<div id="batchCategoryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>批量设置分类</h3>
            <button type="button" class="btn-close" onclick="closeBatchCategoryModal()">✕</button>
        </div>
        <div class="modal-body">
            <form id="batchCategoryForm">
                <div class="form-group">
                    <label for="batchCategorySelect">选择分类</label>
                    <select id="batchCategorySelect" name="category_id" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
                        <option value="">移除分类（设为未分类）</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">确认设置</button>
                    <button type="button" class="btn" onclick="closeBatchCategoryModal()" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Batch Delete Modal -->
<div id="batchDeleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>⚠️ 批量删除文章</h3>
            <button type="button" class="btn-close" onclick="closeBatchDeleteModal()">✕</button>
        </div>
        <div class="modal-body">
            <p style="margin: 1rem 0;">确定要删除 <strong id="deleteCount">0</strong> 篇文章吗？</p>
            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 1rem; margin: 1rem 0;">
                <p style="margin: 0 0 0.5rem 0; font-weight: 500; color: #dc2626;">此操作：</p>
                <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #991b1b;">
                    <li>不可撤销</li>
                    <li>将删除文章及所有评论</li>
                    <li>将删除文章标签关联</li>
                </ul>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-danger" onclick="confirmBatchDelete()" style="flex: 1;">确认删除</button>
                <button type="button" class="btn" onclick="closeBatchDeleteModal()" style="flex: 1;">取消</button>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.modal-body {
    padding: 1.5rem;
}

.batch-actions-bar {
    display: flex;
}
</style>

<script>
let selectedPosts = new Set();

document.addEventListener('DOMContentLoaded', function() {
    // Batch category form
    document.getElementById('batchCategoryForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const categoryId = document.getElementById('batchCategorySelect').value;
        const postIds = Array.from(selectedPosts);

        if (postIds.length === 0) {
            alert('请先选择文章');
            return;
        }

        // Send to backend
        const csrfToken = document.querySelector('meta[name="csrf_token"]').getAttribute('content');
        fetch('/admin/batch-update-category', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                post_ids: postIds,
                category_id: categoryId === '' ? null : parseInt(categoryId),
                csrf_token: csrfToken
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        })
        .catch(error => {
            alert('操作失败：' + error);
        });
    });
});

function filterByCategory() {
    const categoryFilter = document.getElementById('categoryFilter');
    const selectedCategory = categoryFilter.value;

    // Build URL with parameters
    const url = new URL(window.location);
    if (selectedCategory === '') {
        url.searchParams.delete('category_id');
    } else {
        url.searchParams.set('category_id', selectedCategory);
    }
    url.searchParams.set('page', '1'); // Reset to first page when changing category
    url.searchParams.set('per_page', document.getElementById('perPageSelect').value);

    window.location = url.toString();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.post-checkbox');

    checkboxes.forEach(checkbox => {
        const postId = parseInt(checkbox.value);
        const row = checkbox.closest('tr');

        // Only toggle visible rows
        if (row.style.display !== 'none') {
            checkbox.checked = selectAllCheckbox.checked;
            if (checkbox.checked) {
                selectedPosts.add(postId);
            } else {
                selectedPosts.delete(postId);
            }
        }
    });

    updateBatchActions();
}

function changePerPage() {
    const perPage = document.getElementById('perPageSelect').value;
    const categoryFilter = document.getElementById('categoryFilter');
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1'); // Reset to first page

    // Keep category filter
    const selectedCategory = categoryFilter.value;
    if (selectedCategory !== '') {
        url.searchParams.set('category_id', selectedCategory);
    }

    window.location = url.toString();
}

function updateBatchActions() {
    const checkboxes = document.querySelectorAll('.post-checkbox:checked');
    selectedPosts.clear();

    checkboxes.forEach(checkbox => {
        selectedPosts.add(parseInt(checkbox.value));
    });

    const batchActionsBar = document.getElementById('batchActionsBar');
    const selectedCount = document.getElementById('selectedCount');

    if (selectedPosts.size > 0) {
        batchActionsBar.style.display = 'flex';
        selectedCount.textContent = selectedPosts.size;
    } else {
        batchActionsBar.style.display = 'none';
    }
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });

    document.getElementById('selectAll').checked = false;
    selectedPosts.clear();
    updateBatchActions();
}

function showBatchCategoryModal() {
    if (selectedPosts.size === 0) {
        alert('请先选择文章');
        return;
    }

    document.getElementById('batchCategoryModal').style.display = 'flex';
}

function closeBatchCategoryModal() {
    document.getElementById('batchCategoryModal').style.display = 'none';
}

function showBatchDeleteModal() {
    if (selectedPosts.size === 0) {
        alert('请先选择文章');
        return;
    }

    document.getElementById('deleteCount').textContent = selectedPosts.size;
    document.getElementById('batchDeleteModal').style.display = 'flex';
}

function closeBatchDeleteModal() {
    document.getElementById('batchDeleteModal').style.display = 'none';
}

function confirmBatchDelete() {
    const postIds = Array.from(selectedPosts);

    if (postIds.length === 0) {
        alert('请先选择文章');
        return;
    }

    // Send to backend
    const csrfToken = document.querySelector('meta[name="csrf_token"]').getAttribute('content');
    fetch('/admin/batch-delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            post_ids: postIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('操作失败：' + data.message);
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
    });
}
</script>
{% endblock %}
