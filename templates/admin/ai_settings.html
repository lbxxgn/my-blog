{% extends "base.html" %}

{% block title %}AIè®¾ç½® - æˆ‘çš„åšå®¢{% endblock %}

{% block content %}
<div class="container admin-dashboard" style="max-width: 900px;">
    <div class="dashboard-header">
        <h2>AIåŠŸèƒ½è®¾ç½®</h2>
        <div class="header-actions">
            <a href="{{ url_for('admin_dashboard') }}" class="btn">è¿”å›ç®¡ç†åå°</a>
            <a href="{{ url_for('ai_history') }}" class="btn">ä½¿ç”¨å†å²</a>
        </div>
    </div>

    <div class="ai-settings-container">
        <!-- åŠŸèƒ½å¼€å…³ -->
        <div class="ai-section">
            <h3>åŠŸèƒ½è®¾ç½®</h3>
            <div class="ai-setting-item">
                <label class="toggle-label">
                    <input type="checkbox" id="aiEnabled"
                           {% if ai_config and ai_config.ai_tag_generation_enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">å¯ç”¨AIåŠ©æ‰‹åŠŸèƒ½</span>
                </label>
                <p class="setting-description">
                    å¯ç”¨åï¼Œåœ¨ç¼–è¾‘æ–‡ç« æ—¶å¯ä»¥ä½¿ç”¨AIåŠ©æ‰‹åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
                    æ ‡ç­¾ç”Ÿæˆã€æ‘˜è¦ç”Ÿæˆã€æ¨èç›¸å…³æ–‡ç« ã€å†…å®¹ç»­å†™ç­‰ã€‚éœ€è¦é…ç½®APIå¯†é’¥æ‰èƒ½ä½¿ç”¨ã€‚
                    <br><strong style="color: var(--danger-color, #dc3545);">å…³é—­åï¼Œç¼–è¾‘å™¨ä¸­å°†éšè—æ‰€æœ‰AIåŠŸèƒ½æŒ‰é’®ã€‚</strong>
                </p>
            </div>
        </div>

        <!-- AIæä¾›å•†é…ç½® -->
        <div class="ai-section">
            <h3>AIæä¾›å•†é…ç½®</h3>

            <div class="ai-setting-item">
                <label for="aiProvider">AIæä¾›å•†</label>
                <select id="aiProvider" class="form-control">
                    {% for provider in supported_providers %}
                    <option value="{{ provider.id }}"
                            {% if ai_config and ai_config.ai_provider == provider.id %}selected{% endif %}>
                        {{ provider.name }} - {{ provider.description }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="ai-setting-item">
                <label for="aiModel">æ¨¡å‹</label>
                <select id="aiModel" class="form-control">
                    <option value="">è¯·å…ˆé€‰æ‹©æä¾›å•†</option>
                </select>
            </div>

            <div class="ai-setting-item">
                <label for="apiKey">APIå¯†é’¥</label>
                <input type="password" id="apiKey" class="form-control"
                       placeholder="sk-..."
                       {% if ai_config and ai_config.ai_api_key %}value="{{ ai_config.ai_api_key }}"{% endif %}>
                <p class="setting-description">
                    æ‚¨çš„APIå¯†é’¥å°†åŠ å¯†å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ã€‚
                </p>
            </div>

            <div class="ai-actions">
                <button type="button" class="btn" onclick="testConfig()">æµ‹è¯•è¿æ¥</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            </div>
            <p class="setting-description" style="margin-top: 0.5rem;">
                ğŸ’¡ æç¤ºï¼šå¯ä»¥ç›´æ¥ç‚¹å‡»"æµ‹è¯•è¿æ¥"æµ‹è¯•è¡¨å•ä¸­çš„é…ç½®ï¼Œæµ‹è¯•æˆåŠŸåå†ç‚¹å‡»"ä¿å­˜é…ç½®"ã€‚
            </p>

            <div id="testResult" class="ai-test-result" style="display: none;"></div>
        </div>

        <!-- ä½¿ç”¨ç»Ÿè®¡ -->
        {% if stats %}
        <div class="ai-section">
            <h3>ä½¿ç”¨ç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">{{ stats.total_generations }}</div>
                    <div class="stat-label">ç”Ÿæˆæ¬¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ stats.total_tokens }}</div>
                    <div class="stat-label">æ€»Tokenæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">
                        {% if stats.currency == 'CNY' %}Â¥{% else %}${% endif %}{{ "%.4f"|format(stats.total_cost) }}
                    </div>
                    <div class="stat-label">æ€»æˆæœ¬</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ "%.0f"|format(stats.avg_tokens) }}</div>
                    <div class="stat-label">å¹³å‡Token</div>
                </div>
            </div>
            {% if stats.last_used %}
            <p class="stats-last-used">æœ€åä½¿ç”¨: {{ stats.last_used|localtime }}</p>
            {% endif %}
        </div>
        {% endif %}

        <!-- æˆæœ¬è¯´æ˜ -->
        <div class="ai-section ai-info-section">
            <h3>æˆæœ¬è¯´æ˜</h3>

            <!-- OpenAI -->
            <h4 style="margin-top: 0; color: var(--text-color);">OpenAI (ç¾å…ƒ)</h4>
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>æ¨¡å‹</th>
                        <th>è¾“å…¥ (æ¯1K tokens)</th>
                        <th>è¾“å‡º (æ¯1K tokens)</th>
                        <th>é¢„ä¼°å•æ¬¡æˆæœ¬</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>GPT-3.5-turbo</td>
                        <td>$0.0005</td>
                        <td>$0.0015</td>
                        <td>~$0.0005</td>
                    </tr>
                    <tr>
                        <td>GPT-4o</td>
                        <td>$0.005</td>
                        <td>$0.015</td>
                        <td>~$0.005</td>
                    </tr>
                    <tr>
                        <td>GPT-4-turbo</td>
                        <td>$0.01</td>
                        <td>$0.03</td>
                        <td>~$0.01</td>
                    </tr>
                    <tr>
                        <td>GPT-4</td>
                        <td>$0.03</td>
                        <td>$0.06</td>
                        <td>~$0.03</td>
                    </tr>
                </tbody>
            </table>

            <!-- ç«å±±å¼•æ“ -->
            <h4 style="margin-top: 1.5rem; color: var(--text-color);">ç«å±±å¼•æ“ (äººæ°‘å¸)</h4>
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>æ¨¡å‹</th>
                        <th>è¾“å…¥ (æ¯1K tokens)</th>
                        <th>è¾“å‡º (æ¯1K tokens)</th>
                        <th>é¢„ä¼°å•æ¬¡æˆæœ¬</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>doubao-pro-32k</td>
                        <td>Â¥0.00012</td>
                        <td>Â¥0.00012</td>
                        <td>~Â¥0.00004</td>
                    </tr>
                    <tr>
                        <td>doubao-pro-4k</td>
                        <td>Â¥0.00004</td>
                        <td>Â¥0.00004</td>
                        <td>~Â¥0.00001</td>
                    </tr>
                    <tr>
                        <td>doubao-lite-4k</td>
                        <td>Â¥0.00003</td>
                        <td>Â¥0.00003</td>
                        <td>~Â¥0.00001</td>
                    </tr>
                </tbody>
            </table>

            <!-- é˜¿é‡Œç™¾ç‚¼ -->
            <h4 style="margin-top: 1.5rem; color: var(--text-color);">é˜¿é‡Œç™¾ç‚¼ (äººæ°‘å¸)</h4>
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>æ¨¡å‹</th>
                        <th>è¾“å…¥ (æ¯1K tokens)</th>
                        <th>è¾“å‡º (æ¯1K tokens)</th>
                        <th>é¢„ä¼°å•æ¬¡æˆæœ¬</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>qwen-flash <span style="font-size: 0.85em; color: var(--text-secondary);">æ¨è</span></td>
                        <td>Â¥0.0001</td>
                        <td>Â¥0.0002</td>
                        <td>~Â¥0.00004</td>
                    </tr>
                    <tr>
                        <td>qwen-turbo</td>
                        <td>Â¥0.0003</td>
                        <td>Â¥0.0006</td>
                        <td>~Â¥0.0001</td>
                    </tr>
                    <tr>
                        <td>qwen-plus</td>
                        <td>Â¥0.0008</td>
                        <td>Â¥0.002</td>
                        <td>~Â¥0.0003</td>
                    </tr>
                    <tr>
                        <td>qwen-coder-plus</td>
                        <td>Â¥0.0008</td>
                        <td>Â¥0.002</td>
                        <td>~Â¥0.0003</td>
                    </tr>
                    <tr>
                        <td>qwen-long-latest</td>
                        <td>Â¥0.0005</td>
                        <td>Â¥0.002</td>
                        <td>~Â¥0.0003</td>
                    </tr>
                    <tr>
                        <td>qwen-max</td>
                        <td>Â¥0.02</td>
                        <td>Â¥0.06</td>
                        <td>~Â¥0.007</td>
                    </tr>
                    <tr>
                        <td>qwen-vl-max</td>
                        <td>Â¥0.02</td>
                        <td>Â¥0.06</td>
                        <td>~Â¥0.007</td>
                    </tr>
                </tbody>
            </table>
            <p style="margin-top: 0.5rem; font-size: 0.85em; color: var(--text-secondary);">
                æ›´å¤šæ¨¡å‹ï¼šqwen-coder-plus-1106, qwen-coder-plus-latest, qwen-long-2025-01-25, qwen-vl-max-latest
            </p>

            <p class="info-text">
                <strong>æç¤ºï¼š</strong>æ¯æ¬¡ç”Ÿæˆçº¦ä½¿ç”¨200-300 tokensï¼ˆè¾“å…¥ï¼‰ + 50 tokensï¼ˆè¾“å‡ºï¼‰ã€‚
                å›½å†…æ¨¡å‹ï¼ˆç«å±±å¼•æ“ã€é˜¿é‡Œç™¾ç‚¼ï¼‰æˆæœ¬æ˜æ˜¾ä½äºOpenAIï¼Œæ¨èä¼˜å…ˆä½¿ç”¨ã€‚
            </p>
        </div>
    </div>
</div>

<style>
.ai-settings-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.ai-section {
    background: var(--card-bg, #fff);
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 12px;
    padding: 1.5rem;
}

.ai-section h3 {
    margin: 0 0 1.5rem 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color, #1f2937);
}

.ai-section h4 {
    margin: 1.5rem 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-color, #1f2937);
}

.ai-section h4:first-child {
    margin-top: 0;
}

.ai-setting-item {
    margin-bottom: 1.5rem;
}

.ai-setting-item:last-child {
    margin-bottom: 0;
}

.ai-setting-item label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-color, #1f2937);
}

.ai-setting-item .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 8px;
    font-size: 1rem;
    background: var(--input-bg, #fff);
    color: var(--text-color, #1f2937);
}

.setting-description {
    margin: 0.5rem 0 0 0;
    font-size: 0.875rem;
    color: var(--text-secondary, #6b7280);
    line-height: 1.5;
}

/* Toggle Switch */
.toggle-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
}

.toggle-label input[type="checkbox"] {
    position: relative;
    width: 50px;
    height: 26px;
    appearance: none;
    background: var(--border-color, #e5e7eb);
    border-radius: 13px;
    outline: none;
    transition: background 0.3s;
}

.toggle-label input[type="checkbox"]::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
}

.toggle-label input[type="checkbox"]:checked {
    background: #10b981;
}

.toggle-label input[type="checkbox"]:checked::after {
    transform: translateX(24px);
}

.toggle-text {
    font-weight: 500;
    color: var(--text-color, #1f2937);
}

/* Actions */
.ai-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color, #e5e7eb);
}

/* Test Result */
.ai-test-result {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
}

.ai-test-result.success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #10b981;
}

.ai-test-result.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #ef4444;
}

/* Stats */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: var(--code-bg, #f9fafb);
    border-radius: 8px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color, #10b981);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary, #6b7280);
    margin-top: 0.25rem;
}

.stats-last-used {
    margin-top: 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary, #6b7280);
}

/* Cost Table */
.cost-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.cost-table th,
.cost-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
}

.cost-table th {
    font-weight: 600;
    color: var(--text-color, #1f2937);
    background: var(--code-bg, #f9fafb);
}

.cost-table tr:last-child td {
    border-bottom: none;
}

.info-text {
    margin-top: 1rem;
    padding: 0.75rem;
    background: var(--code-bg, #f9fafb);
    border-left: 3px solid var(--primary-color, #10b981);
    border-radius: 4px;
    font-size: 0.875rem;
    line-height: 1.5;
}

.ai-info-section {
    background: var(--card-bg, #f9fafb);
}

/* Dark theme */
.dark-theme .ai-section {
    background: #1f2937;
    border-color: #374151;
}

.dark-theme .ai-setting-item .form-control {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

.dark-theme .toggle-label input[type="checkbox"] {
    background: #4b5563;
}

.dark-theme .stat-item {
    background: #374151;
}

.dark-theme .cost-table th {
    background: #374151;
}

.dark-theme .info-text,
.dark-theme .ai-info-section {
    background: #374151;
}
</style>

<script>
// Provider models mapping
const providerModels = {{ supported_providers|tojson }};

// Update model options based on selected provider
function updateModelOptions() {
    const provider = document.getElementById('aiProvider').value;
    const modelSelect = document.getElementById('aiModel');
    const currentConfig = {{ ai_config|tojson }};

    modelSelect.innerHTML = '';

    const providerInfo = providerModels.find(p => p.id === provider);
    if (providerInfo) {
        providerInfo.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            if (currentConfig && currentConfig.ai_model === model) {
                option.selected = true;
            }
            modelSelect.appendChild(option);
        });
    }
}

// Initialize model options on page load
document.addEventListener('DOMContentLoaded', function() {
    updateModelOptions();
    document.getElementById('aiProvider').addEventListener('change', updateModelOptions);
});

// Test AI configuration
async function testConfig() {
    const resultDiv = document.getElementById('testResult');
    resultDiv.style.display = 'block';
    resultDiv.className = 'ai-test-result';
    resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';

    // Get current form values
    const config = {
        ai_provider: document.getElementById('aiProvider').value,
        ai_model: document.getElementById('aiModel').value,
        ai_api_key: document.getElementById('apiKey').value
    };

    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf_token"]').content;

    try {
        const response = await fetch('/admin/ai/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(config)
        });

        const data = await response.json();

        if (data.success) {
            resultDiv.classList.add('success');
            resultDiv.textContent = 'âœ… ' + data.message;
        } else {
            resultDiv.classList.add('error');
            resultDiv.textContent = 'âŒ ' + data.message;
        }
    } catch (error) {
        resultDiv.classList.add('error');
        resultDiv.textContent = 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message;
    }
}

// Save AI configuration
async function saveConfig() {
    const resultDiv = document.getElementById('testResult');
    resultDiv.style.display = 'block';
    resultDiv.className = 'ai-test-result';
    resultDiv.textContent = 'æ­£åœ¨ä¿å­˜é…ç½®...';

    const config = {
        ai_tag_generation_enabled: document.getElementById('aiEnabled').checked,
        ai_provider: document.getElementById('aiProvider').value,
        ai_model: document.getElementById('aiModel').value,
        ai_api_key: document.getElementById('apiKey').value
    };

    console.log('Saving AI config:', {
        ...config,
        ai_api_key: config.ai_api_key ? '***' + config.ai_api_key.slice(-4) : '(empty)'
    });

    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf_token"]').content;

    try {
        const response = await fetch('/admin/ai/configure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(config)
        });

        console.log('Response status:', response.status);

        // Check if response is OK
        if (!response.ok) {
            const responseText = await response.text();
            console.error('Server returned error:', response.status, responseText);
            resultDiv.classList.add('error');
            resultDiv.textContent = `âŒ æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${responseText.substring(0, 200)}`;
            return;
        }

        const data = await response.json();
        console.log('Response data:', data);

        if (data.success) {
            resultDiv.classList.add('success');
            resultDiv.textContent = 'âœ… é…ç½®å·²ä¿å­˜ï¼';
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 3000);
        } else {
            resultDiv.classList.add('error');
            resultDiv.textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + data.error;
        }
    } catch (error) {
        console.error('Save config error:', error);
        resultDiv.classList.add('error');
        resultDiv.textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + error.message;
    }
}
</script>
{% endblock %}
